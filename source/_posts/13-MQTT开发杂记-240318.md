---
title: MQTT开发杂记
category: 其他的开发杂记
date: 2024-03-18 18:00:00
index_img: https://mosquitto.org/images/mosquitto-text-side-28.png
---

![封面](https://mosquitto.org/images/mosquitto-text-side-28.png)

# tl;dr
由于毕设需要用到`mqtt`网络协议栈，~~但这个协议我一直没用过，~~所以打算写这篇博客来记录一下搭建过程。


# `MQTT`的工作流程
这是一个需要中心化服务器的协议。中心服务器通常称为`broker`，
**MQTT（Message Queuing Telemetry Transport）** 是一种轻量级的、基于发布/订阅模式的通信协议，常用于物联网设备之间的通信~~*废话*~~。
其工作流程如下：
1. **连接建立阶段**：
    - 客户端通过`TCP`连接到`MQTT`代理服务器（通常称为`MQTT Broker`）。
    - 客户端发送`CONNECT`报文，包含客户端ID、用户名、密码等信息。
    - 服务器响应`CONNACK`报文，表示连接建立成功或失败。
2. **订阅主题**：
    - 客户端发送`SUBSCRIBE`报文，指定感兴趣的主题和`QoS`级别。
    - 服务器记录客户端的订阅关系。
3. **发布消息**：
    - 客户端发送`PUBLISH`报文，包含主题和消息内容。
    - 服务器将消息传送给所有订阅了相应主题的客户端。
4. **接收消息**：
    - 客户端接收到服务器发送的`PUBLISH`报文，获取消息内容。
5. **取消订阅**：
    - 客户端发送`UNSUBSCRIBE`报文，取消对某个主题的订阅。
6. **断开连接**：
    - 客户端或服务器可以发送`DISCONNECT`报文，正常断开连接。

当有n个客户端订阅了同一个主题`we_are_ikun`，这n个人谁都可以`publish`一条包含自定义内容的报文`jntm`，随后经由`broker`，会将该消息转发给***包括***他的所有订阅了`we_are_ikun`的终端上。此时，其他终端里任何一个人也可以再`publish`一条包含自定义消息的报文`ni gan ma haha aiyo amagi`，该报文会经由`broker`再转发给包括他的所有终端。
> 是不是很像一个聊天室？对没错！就想象是一群~~*小黑子*~~ ikun呆在同一个房间里一起谈论哥哥的篮球和背带一样，A说的话能被房间里其他人听到，B说的话也可以被其他人听到。


# 服务器搭建
我使用的测试服务器是运行在`VMware`中的`Alpine Linux`，连接模式选择桥接，以便可以和`esp8266`在同一个子网下。
我使用的客户端有两台，一台是上述虚拟机，一台是我的安卓手机，使用`termux`。
在装好了系统的虚拟机中安装好`mosquitto`和`mosquitto-clients`软件包。
在`termux`中安装`mosquitto`软件包，不需要安装clients包，因为它包含了`mosquitto_pub`和`mosquitto_sub`两个程序。
> 详见GitHub issues [#613](https://github.com/termux/termux-packages/issues/613)。

# 使用虚拟机和`termux`进行简单的`MQTT`通信实验
[本教程参考官方repo的readme](https://github.com/eclipse/mosquitto)
在虚拟机中定位到配置文件`/etc/mosquitto/mosquitto.conf`：
> 在`termux`中，该配置文件的路径是`/data/user/0/com.termux/files/usr/etc/mosquitto/mosquitto.conf`

取消注释`log_type all`以将日志等级设置为`all`，将`log_dest`设置为`stdout`，要不然不会在屏幕上显示日志。
或者直接添加下面两行也行：~~我后来试了一下日志等级不设其实也ok~~
``` text
log_dest stdout
log_type all
```
添加以下两行以开启在`0.0.0.0`监听、允许匿名登录：
``` text
listener 1883 0.0.0.0
allow_anonymous true
```

在***虚拟机***的`tty1`中启动`mosquitto`服务端程序（使用默认端口`1883`开服）：
``` shell
mosquitto -c /etc/mosquitto/mosquitto.conf -v
```

进入`tty2`和`termux`，订阅`testTopic`的主题：
``` shell
mosquitto_sub -h 192.168.146.138 -p 1883 -t "testTopic"
```

进入`tty3`，向主题`publish`一条消息：
``` shell
mosquitto_pub -h 192.168.146.138 -p 1883 -t "testTopic" -m "message from tty3"
```
回到`tty2`，看看是不是多了一条来自`tty3`的消息？`termux`里是不是也有这条消息？
进入`termux`，再开一个`session`，向主题`publish`一条消息：
``` shell
mosquitto_pub -h 192.168.146.138 -p 1883 -t "testTopic" -m "message from termux"
```
回到上一个`session`，看看是不是多了这条消息？`tty2`里是不是也多了这条消息？


# 如何确保`MQTT`通信的安全？
这就是简单的`MQTT`通信实验。我们上点难度：**加个鉴权**。
`MQTT`支持密码和密钥两种认证方式，我们先从密码开始。[参考mqtt官方文档](http://www.steves-internet-guide.com/mqtt-username-password-example/)
进入虚拟机，停掉刚刚那个谁都可以加进来的mqtt服务器，编辑`/etc/mosquitto/mosquitto.conf`，将`allow_anonymous`设置为`false`，再添加一行，指向存放密码文件的路径(记得创建这个文件)：
``` text
password_file /etc/mosquitto/passwordfile
```
> ⚠注意：在`Linux`上，需要将密码文件存放到`/etc/mosquitto`下，要不然就算你在`mosquitto.conf`中写入了`password_file`，也无法读取密码文件。

***添加用户 -方法 1***
往`/etc/mosquitto/passwordfile`里写入账号和明文密码，一行一个，像这样：
``` text
user1:passwd1
usr2:pwd2
```
然后运行这行命令来将密码文件加密。
``` shell
mosquitto_passwd -U passwordfile
```
如果有用户是在加密过之后再被添加，写了明文密码，需要再运行一次加密，但是这次加密的时候，系统会只加密明文密码，之前被加密过的密文不会被二次加密。
> 密码文件必须加密后才能被读取使用！


***添加用户 -方法 2***
现在，我们添加一个用户，叫`alpine`，密码`a123456`：
``` shell
mosquitto_passwd -c /etc/mosquitto/passwordfile alpine
```
然后系统会提示你输入该用户的密码，和linux设置用户密码一样。
现在，我们再添加一个用户，叫`termux`，密码`t123456`：
``` shell
mosquitto_passwd -b /etc/mosquitto/passwordfile termux t123456
```
> 注意这里的参数！
> `-c`是在没有任何用户的情况下，初始化密码文件用。***会覆盖写入文件***
> `-b`是在有用户的情况下使用。***会追加写入文件***。增加用户时命令行里需要传递明文密码了。

现在，我们删除一个用户，把上面的`user1`删了：
``` shell
mosquitto_passwd -D /etc/mosquitto/passwordfile user1
```

在运行的时候，没有关闭`mosquitto`服务器，但添加/删除了用户，怎么重新加载配置文件呢？新开一个终端(或者`tty`)，运行下面这个命令即可：
``` shell
kill -HUP "$(mosquitto)"
```
然后就能在运行着`mosquitto`的终端里看到`Reloading config.`的提示了，此时新的用户清单会被应用。


***怎么连接呢？***
使用 `mosquitto_sub` 进行订阅，该话题下所有的消息都会显示在这里：
``` bash
mosquitto_sub -h <broker_addr> -p <broker_port> -t <topic> -i <device_identifier> -u <username> -P <password>
```

使用 `mosquitto_pub` 往指定的话题`publish`内容：
``` shell
mosquitto_pub -h <broker_address> -t <topic> -i <device_identifier> -m "message" -u <username> -P <password>
```


