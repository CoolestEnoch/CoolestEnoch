---
title: XPosed模块开发踩坑
category: Android
date: 2024-03-30 18:00:00
index_img: https://devsjournal.com/wp-content/uploads/2015/12/Download-Xposed-Framework-and-Installer-for-Android.jpg
---

![img](https://devsjournal.com/wp-content/uploads/2015/12/Download-Xposed-Framework-and-Installer-for-Android.jpg)
(图源[Download Xposed Framework and Installer](https://devsjournal.com/download-install-xposed-installer-framework-android.html))

# tl;dr
为了在毕设里加入语音控制，计划对系统语音助手进行动态注入以实现语音控制，技术选型为`XPosed`。~~*谁家自动化毕设代码要注入别的进程啊🤣👉*~~


# XPosed模块开发环境搭建
本文选用的是基于[`EzXHelper`](https://github.com/KyuubiRan/EzXHelper) + [`DexKit`](https://github.com/LuckyPray/DexKit)的开发环境。

一切的首先：Android studio创建工程。
在`build.gradle.kts(app)`中添加以下依赖项：
``` kotlin
// EzX Helper  
implementation("com.github.kyuubiran:EzXHelper:1.0.3")  
compileOnly("de.robv.android.xposed:api:82")  
  
// Dex Kit  
implementation("org.luckypray:dexkit:2.0.0")
```

在`settings.gradle.kts`中的`dependencyResolutionManagement`添加以下两个仓库：
``` kotlin
maven(url = "https://jitpack.io")  
maven(url = "https://api.xposed.info")
```

在`AndroidManifest.xml`中的`application`节点中添加以下键值以能在`LSPosed`中显示模块信息：
``` xml
<meta-data  
    android:name="xposedmodule"  
    android:value="true" />  
<meta-data  
    android:name="xposeddescription"  
    android:value="@string/xposeddescription" />  <!--这是在模块名称下面的小字-->
<meta-data  
    android:name="xposedminversion"  
    android:value="93" />  
<meta-data  
    android:name="xposedscope"  
    android:resource="@array/xposed_scope" /><!--作用域-->
```

其中作用域的xml文件这么填(一行一个包名)：
``` xml
<?xml version="1.0" encoding="utf-8"?>  
<resources>  
    <string-array name="xposed_scope">  
       <item>com.android.launcher3</item>  
    </string-array>
</resources>
```

创建xposed的主hook类(我创建在`com.example.package`下，叫`HookEntry.kt`)：
``` kotlin
class HookEntry : IXposedHookLoadPackage, IXposedHookZygoteInit {  
  
    override fun initZygote(startupParam: IXposedHookZygoteInit.StartupParam) {  
       EzXHelperInit.initZygote(startupParam)  
    }  
  
    override fun handleLoadPackage(lpparam: XC_LoadPackage.LoadPackageParam) {  
       val packageName: String = lpparam.packageName  
       EzXHelperInit.initHandleLoadPackage(lpparam)  
  
       when (packageName) {  
          // 修改模块激活状态, 这里需要你的MainActivity下有一个叫isActive的函数, 并且是调用就直接返回false的。在激活模块后，下面的hook代码会让它返回true以实现让它知道模块激活了。
          BuildConfig.APPLICATION_ID -> {  
             findMethod("com.example.package.MainActivity") {  
                name == "isActive" && returnType == Boolean::class.java  
             }.hookBefore {  
                it.result = true  
             }  
          }  
          "target.package.name" -> {/* your hook code here */ }  
       }  
    }  
}
```

然后创建`assets`文件夹，里面创建`xposed_init`文件，写入上面那个类文件的包名:
``` text
com.example.package.HookEntry
```
> 这里不需要管扩展名，不用像在`java`里调用`kotlin`需要写`HookEntryKt.xxx`一样



# 提示`duplicated class`怎么办
在`gradle.properties`里确保添加了以下两行：
``` prop
android.useAndroidX=true
android.enableJetifier=true
```


# `LSPosed`提示关闭`部署优化`，怎么操作
Android studio左上角三横 - `Run` - `Edit Configurations...` - 取消勾选`Always install with package manager`，保存！